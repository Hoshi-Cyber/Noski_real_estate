---
// src/layouts/MainLayout.astro
/**
 * MainLayout.astro
 * SEO upgrades: canonical URL, OG/Twitter defaults. Safe UTM stripping.
 * Accepts optional: canonical, noIndex, seoImage
 */
const {
  title = 'Severino Realty',
  description = 'Discover Nairobi real estate with Severino Realty',
  seoImage,
  canonical,
  noIndex = false,
} = Astro.props;

import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

/* Build canonical without tracking params */
const url = new URL(Astro.url);
['utm_source','utm_medium','utm_campaign','utm_content'].forEach(k => url.searchParams.delete(k));
const canonicalUrl = canonical ?? url.toString();

const siteName = 'Severino Realty';
const ogImgPath = seoImage ?? '/images/og-default.jpg';
const ogImgAbs = ogImgPath.startsWith('http') ? ogImgPath : new URL(ogImgPath, url.origin).toString();
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph -->
    <meta property="og:site_name" content={siteName} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImgAbs} />
    <meta property="og:image:alt" content={title} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImgAbs} />

    <!-- Icons -->
    <link rel="icon" type="image/png" href="/images/placeholder.webp" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/placeholder.webp" sizes="64x64" />

    <!-- Passive prefetch hints (safe) -->
    <link rel="prefetch" href="/developments/">
    <link rel="prefetch" href="/developments/new/">
    <link rel="prefetch" href="/developments/unfinished/">
  </head>
  <body class="overflow-x-hidden bg-neutral-50 text-neutral-900">
    <Header />

    <main id="main" class="min-h-[70vh] overflow-x-hidden" role="main">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumbs slot rendered tightly above first heading/section -->
        <nav aria-label="Breadcrumb" id="breadcrumbs" class="mb-2">
          <slot name="breadcrumbs" />
        </nav>

        <!-- Page content -->
        <div id="page-body">
          <slot />
        </div>
      </div>
    </main>

    <Footer />

    <!-- Hover prefetch for dropdown targets (enhances perceived speed) -->
    <script type="module">
      const routes = [
        '/developments/',
        '/developments/new/',
        '/developments/unfinished/',
        '/listings/',
        '/for-sale/',
        '/for-rent/',
        '/short-stays/',
        '/resources/guides/',
        '/resources/faqs/',
        '/resources/market-reports/',
        '/blog/'
      ];

      function prefetch(href) {
        if (!href || document.querySelector(`link[rel="prefetch"][href="${href}"]`)) return;
        const l = document.createElement('link');
        l.rel = 'prefetch';
        l.href = href;
        document.head.appendChild(l);
      }

      const ids = ['listings-btn','dev-btn','res-btn'];
      ids.forEach((id) => {
        const el = document.getElementById(id);
        el?.addEventListener('mouseenter', () => routes.forEach(prefetch), { passive: true });
        el?.addEventListener('focus', () => routes.forEach(prefetch), { passive: true });
      });

      // Also prefetch on hover of any header nav links
      document.addEventListener('mouseover', (e) => {
        const a = (e.target)?.closest('a');
        if (a && a.href && a.origin === location.origin) {
          const href = a.pathname.endsWith('/') ? a.pathname : a.pathname + '/';
          prefetch(href);
        }
      }, { passive: true });
    </script>

    <!-- Tighten spacing between breadcrumbs and the first section/heading -->
    <style is:global>
      /* Collapse any top margin/padding on the first block after breadcrumbs */
      #breadcrumbs + #page-body > :first-child { margin-top: 0 !important; padding-top: 0 !important; }
      /* If the first child is a header element */
      #breadcrumbs + #page-body > header:first-child { margin-top: 0 !important; padding-top: 0 !important; }
      /* If the first child uses a .section wrapper */
      #breadcrumbs + #page-body > .section:first-child { margin-top: 0 !important; padding-top: 0 !important; }
    </style>
  </body>
</html>
