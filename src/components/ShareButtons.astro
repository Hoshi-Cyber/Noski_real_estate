---
/**
 * Reusable, branded, responsive share widget.
 * - Eliminates large-screen blank gaps by using a compact, flexible rail.
 * - Uses native share when available; otherwise falls back to links + copy.
 * - Branded SVG icons (Facebook, X, WhatsApp, LinkedIn, Email) + Copy + “More”.
 * - Accessible (ARIA labels, keyboard, focus rings via global.css).
 */

export interface Props {
  url: string;
  title?: string;
  label?: string;        // Left label text; default "Share this listing"
  class?: string;        // Optional extra classes for the outer rail
  compact?: boolean;     // If true, hides the left label
}

const { url, title = "", label = "Share this listing", class: extra = "", compact = false } = Astro.props;

const enc = encodeURIComponent;
const share = {
  fb: `https://www.facebook.com/sharer/sharer.php?u=${enc(url)}`,
  x:  `https://twitter.com/intent/tweet?url=${enc(url)}&text=${enc(title)}`,
  li: `https://www.linkedin.com/sharing/share-offsite/?url=${enc(url)}`,
  wa: `https://wa.me/?text=${enc(`${title} ${url}`)}`,
  em: `mailto:?subject=${enc(title)}&body=${enc(`${title}\n${url}`)}`,
  sms:`sms:?&body=${enc(`${title} ${url}`)}`
};

// Unique ids so multiple widgets on a page work independently
const uid = Math.random().toString(36).slice(2);
const ids = {
  moreBtn:  `share-more-${uid}`,
  popover:  `share-pop-${uid}`,
  copyBtn:  `share-copy-${uid}`,
};
---

<!--
  Compact, gapless rail. Uses site styles:
  - .share-rail  (rounded, ring, shadow, padding)
  - .share-btn   (button/link visuals)
  - .share-btn-icon (square icon button size)
  - .share-title (small label with dot)
-->
<div class={`share-rail ${extra}`} role="group" aria-label="Share">
  {!compact && <span class="share-title">{label}</span>}

  <div class="flex items-center gap-2 flex-wrap">
    <!-- Facebook -->
    <a class="share-btn share-btn-icon" href={share.fb} target="_blank" rel="noopener" aria-label="Share on Facebook" title="Facebook">
      <!-- Brand: #1877F2 -->
      <svg viewBox="0 0 24 24" aria-hidden="true" fill="#1877F2"><path d="M22 12.06C22 6.48 17.52 2 11.94 2S2 6.48 2 12.06c0 5 3.66 9.14 8.44 9.94v-7.03H8.08v-2.9h2.36V9.41c0-2.33 1.39-3.62 3.53-3.62 1.02 0 2.09.18 2.09.18v2.3h-1.18c-1.16 0-1.52.72-1.52 1.46v1.75h2.59l-.41 2.9h-2.18V22c4.78-.8 8.44-4.94 8.44-9.94z"/></svg>
    </a>

    <!-- X (Twitter) -->
    <a class="share-btn share-btn-icon" href={share.x} target="_blank" rel="noopener" aria-label="Share on X" title="X">
      <!-- Brand (current): solid black -->
      <svg viewBox="0 0 24 24" aria-hidden="true" fill="#000"><path d="M18.9 2H21l-6.5 7.43L22 22h-6.8l-4.77-6.22L4.8 22H2.7l7-8L2 2h6.9l4.33 5.73L18.9 2Zm-2.38 18h1.31L7.58 4h-1.3l10.24 16Z"/></svg>
    </a>

    <!-- WhatsApp -->
    <a class="share-btn share-btn-icon" href={share.wa} target="_blank" rel="noopener" aria-label="Share on WhatsApp" title="WhatsApp">
      <!-- Brand: #25D366 -->
      <svg viewBox="0 0 32 32" aria-hidden="true" fill="#25D366"><path d="M19.11 17.41c-.27-.14-1.57-.77-1.82-.85-.24-.09-.42-.14-.6.14-.17.27-.68.85-.83 1.02-.15.17-.31.2-.58.07-.27-.14-1.14-.42-2.18-1.34-.8-.71-1.34-1.58-1.5-1.85-.16-.27-.02-.42.12-.56.12-.12.27-.31.4-.46.14-.15.18-.25.27-.42.09-.17.05-.31-.02-.45-.07-.14-.6-1.44-.82-1.97-.22-.53-.44-.46-.6-.46-.16 0-.34-.02-.52-.02-.18 0-.45.07-.68.31-.24.24-.89.87-.89 2.11 0 1.24.91 2.44 1.04 2.61.12.17 1.79 2.73 4.33 3.82.61.26 1.08.42 1.45.54.61.19 1.17.16 1.61.1.49-.07 1.57-.64 1.79-1.26.22-.62.22-1.15.15-1.26-.07-.11-.24-.18-.51-.32z"/><path d="M26.7 5.3C24.1 2.7 20.65 1.3 17 1.3 9.94 1.3 4.3 6.94 4.3 14c0 2.25.59 4.45 1.71 6.39L4 28l7.79-2c1.84 1 3.92 1.52 6.04 1.52 7.06 0 12.7-5.64 12.7-12.7 0-3.38-1.32-6.56-3.83-9.08z"/></svg>
    </a>

    <!-- LinkedIn -->
    <a class="share-btn share-btn-icon" href={share.li} target="_blank" rel="noopener" aria-label="Share on LinkedIn" title="LinkedIn">
      <!-- Brand: #0A66C2 -->
      <svg viewBox="0 0 24 24" aria-hidden="true" fill="#0A66C2"><path d="M19 3A2.94 2.94 0 0 1 22 6v12a2.94 2.94 0 0 1-3 3H5a2.94 2.94 0 0 1-3-3V6a2.94 2.94 0 0 1 3-3Zm-9.94 16V10.5H6v8.5Zm-.5-9.69a1.31 1.31 0 1 0 0-2.62 1.31 1.31 0 0 0 0 2.62ZM20 19V14.3c0-2.24-1.2-3.29-2.81-3.29a2.42 2.42 0 0 0-2.2 1.21h-.03V10.5h-3v8.5h3v-4.71c0-1.24.24-2.43 1.76-2.43s1.58 1.37 1.58 2.51V19Z"/></svg>
    </a>

    <!-- Email -->
    <a class="share-btn share-btn-icon" href={share.em} aria-label="Share via Email" title="Email">
      <svg viewBox="0 0 24 24" aria-hidden="true" fill="#6B7280"><path d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 4-8 5L4 8V6l8 5 8-5v2Z"/></svg>
    </a>

    <!-- Copy link -->
    <button id={ids.copyBtn} class="share-btn share-btn-icon" type="button" aria-label="Copy link" title="Copy link">
      <svg viewBox="0 0 24 24" aria-hidden="true" fill="#0A2A42"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1Zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2Zm0 16H8V7h11v14Z"/></svg>
    </button>

    <!-- More (popover) -->
    <button id={ids.moreBtn} class="share-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls={ids.popover}>
      More
    </button>
  </div>

  <div id={ids.popover} class="hidden popover" role="menu" aria-label="More share options">
    <div class="popover-arrow" aria-hidden="true"></div>
    <div class="grid grid-cols-2 gap-2">
      <a class="share-btn justify-center" href={share.sms}>Text</a>
      <a class="share-btn justify-center" href={share.em}>Email</a>
    </div>
  </div>
</div>

<!-- Client behavior: native share, copy, and popover toggle -->
<script is:inline>
{`
  (function(){
    const moreBtn = document.getElementById('${ids.moreBtn}');
    const pop     = document.getElementById('${ids.popover}');
    const copyBtn = document.getElementById('${ids.copyBtn}');
    const pageUrl = ${JSON.stringify(url)};
    const title   = ${JSON.stringify(title)};

    const closePop = () => { if(pop){ pop.classList.add('hidden'); moreBtn?.setAttribute('aria-expanded','false'); } };
    const openPop  = () => { if(pop){ pop.classList.remove('hidden'); moreBtn?.setAttribute('aria-expanded','true'); } };

    // Prefer native share on the "More" button when available
    if (moreBtn) {
      if (navigator.share) {
        moreBtn.addEventListener('click', () => {
          navigator.share({ title, url: pageUrl }).catch(()=>{});
        });
      } else {
        moreBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if(pop?.classList.contains('hidden')) openPop(); else closePop();
        });
        document.addEventListener('click', (e) => { if(pop && !pop.contains(e.target) && e.target !== moreBtn) closePop(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePop(); });
      }
    }

    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(pageUrl);
          const old = copyBtn.innerHTML;
          copyBtn.setAttribute('aria-live','polite');
          copyBtn.innerHTML = 'Copied';
          setTimeout(()=> copyBtn.innerHTML = old, 1200);
        } catch {}
      });
    }
  })();
`}
</script>
