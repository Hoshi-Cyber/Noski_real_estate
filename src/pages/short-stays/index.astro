---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import PropertyCard from '../../components/PropertyCard.astro';

// Utils
const ts = (d:any) => {
  const val = d?.updatedAt || d?.publishedAt || d?.createdAt || d?.date || 0;
  const n = new Date(val).getTime();
  return Number.isFinite(n) ? n : 0;
};
const isCoastal = (loc = '') => /diani|mombasa|nyali|malindi|watamu|kilifi/i.test(loc || '');
const bedsNum = (v:any) => (Number.isFinite(v) ? Number(v) : Number(v || 0)) || 0;

// Data: SHORT only
const all = await getCollection('listings');
const shortOnly = all.filter(e => (e.data.availability || '').toLowerCase().includes('short'));

// Dedupe helper
const seen = new Set<string>();
const take = (arr:any[], limit:number) => {
  const out:any[] = [];
  for (const e of arr) {
    if (seen.has(e.slug)) continue;
    out.push(e);
    seen.add(e.slug);
    if (out.length >= limit) break;
  }
  return out;
};

// Sections
const newest   = [...shortOnly].sort((a,b) => ts(b.data) - ts(a.data));
const secNew   = take(newest, 4);

const groups   = shortOnly.filter(e => bedsNum((e.data as any).bedrooms) >= 3);
const secGroup = take(groups, 4);

const coastals = shortOnly.filter(e => isCoastal((e.data as any).location));
const secCoast = take(coastals, 4);
---

<MainLayout
  title="Short Stays in Kenya"
  description="Curated short-term stays: new this month, great for groups, and coastal getaways. Use full search for all filters."
>
  <section class="py-12 max-w-7xl mx-auto px-4">
    <!-- Mobile-friendly header actions -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <h1 class="text-3xl font-bold text-primary">Short-Term Stays</h1>

      <!-- Compact, single-row, scrollable on small screens -->
      <div class="-mx-1 max-w-full overflow-x-auto scrollbar-hide">
        <div class="flex gap-2 px-1">
          <a href="/listings?availability=short-stays" class="btn-cta cta-fluid shrink-0 whitespace-nowrap">Browse all short stays</a>
          <a href="/for-sale" class="btn-outline cta-fluid shrink-0 whitespace-nowrap">For Sale</a>
          <a href="/for-rent" class="btn-outline cta-fluid shrink-0 whitespace-nowrap">For Rent</a>
        </div>
      </div>
    </div>

    {secNew.length > 0 && (
      <>
        <header class="landing-head mb-3">
          <h2 class="landing-h2">New this month</h2>
          <a href="/listings?availability=short-stays&sort=date_desc" class="btn-subtle cta-fluid shrink-0 whitespace-nowrap">See more</a>
        </header>
        <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-10">
          {secNew.map(e => (<li><PropertyCard listing={e.data} slug={e.slug} /></li>))}
        </ul>
      </>
    )}

    {secGroup.length > 0 && (
      <>
        <header class="landing-head mb-3">
          <h2 class="landing-h2">Great for groups (3+ beds)</h2>
          <a href="/listings?availability=short-stays" class="btn-subtle cta-fluid shrink-0 whitespace-nowrap">See all group stays</a>
        </header>
        <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-10">
          {secGroup.map(e => (<li><PropertyCard listing={e.data} slug={e.slug} /></li>))}
        </ul>
      </>
    )}

    {secCoast.length > 0 && (
      <>
        <header class="landing-head mb-3">
          <h2 class="landing-h2">Beach & coastal</h2>
          <a href="/listings?availability=short-stays" class="btn-subtle cta-fluid shrink-0 whitespace-nowrap">See all coastal stays</a>
        </header>
        <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {secCoast.map(e => (<li><PropertyCard listing={e.data} slug={e.slug} /></li>))}
        </ul>
      </>
    )}
  </section>
</MainLayout>

<!-- Cosmetic: ensure URL shows ?availability=short-stays for share/back/forward context -->
<script is:inline>
  (function () {
    try {
      const u = new URL(window.location.href);
      if (u.searchParams.get('availability') !== 'short-stays') {
        u.searchParams.set('availability', 'short-stays');
        history.replaceState({}, '', u);
      }
    } catch {}
  })();
</script>
