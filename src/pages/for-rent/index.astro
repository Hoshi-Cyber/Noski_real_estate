---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import PropertyCard from '../../components/PropertyCard.astro';

// Utils
const num = (v:any) => {
  if (typeof v === 'number') return v;
  const n = Number(String(v || '').replace(/[^\d]/g, ''));
  return Number.isFinite(n) ? n : 0;
};
const ts = (d:any) => {
  const val = d?.updatedAt || d?.availableFrom || d?.publishedAt || d?.createdAt || d?.date || 0;
  const n = new Date(val).getTime();
  return Number.isFinite(n) ? n : 0;
};

// Data: RENT only
const all = await getCollection('listings');
const rentOnly = all.filter(e => (e.data.availability || '').toLowerCase().includes('rent'));

// Sections (dedupe)
const seen = new Set<string>();
const take = (arr:any[], limit:number) => {
  const out:any[] = [];
  for (const e of arr) {
    if (seen.has(e.slug)) continue;
    out.push(e);
    seen.add(e.slug);
    if (out.length >= limit) break;
  }
  return out;
};

// Featured & New
const featured = rentOnly.filter(e => !!(e.data as any).featured);
const newest   = [...rentOnly].sort((a,b) => ts(b.data) - ts(a.data));
const secFeaturedNew = take([...featured, ...newest], 4);

// Affordable (≤ KSh 150k)
const affordable = rentOnly.filter(e => num((e.data as any).price) > 0 && num((e.data as any).price) <= 150_000);
const secAffordable = take(affordable.sort((a,b)=> num(a.data.price)-num(b.data.price)), 4);

// Premium (≥ KSh 250k)
const premium = rentOnly.filter(e => num((e.data as any).price) >= 250_000);
const secPremium = take(premium.sort((a,b)=> num(b.data.price)-num(a.data.price)), 4);
---

<MainLayout
  title="Homes for Rent in Nairobi"
  description="Curated rentals: featured & new, affordable, and premium picks. Jump to full search for filters and pagination."
>
  <section class="py-12 max-w-7xl mx-auto px-4">
    <!-- Mobile-friendly header actions -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <h1 class="text-3xl font-bold text-primary">Homes for Rent</h1>

      <!-- Compact, single-row, scrollable on small screens -->
      <div class="-mx-1 max-w-full overflow-x-auto scrollbar-hide">
        <div class="flex gap-2 px-1">
          <a href="/listings?availability=for-rent" class="btn-cta cta-fluid shrink-0 whitespace-nowrap">Browse all for rent</a>
          <a href="/for-sale" class="btn-outline cta-fluid shrink-0 whitespace-nowrap">For Sale</a>
          <a href="/short-stays" class="btn-outline cta-fluid shrink-0 whitespace-nowrap">Short Stays</a>
        </div>
      </div>
    </div>

    {secFeaturedNew.length > 0 && (
      <>
        <header class="landing-head mb-3">
          <h2 class="landing-h2">Featured & New</h2>
          <a href="/listings?availability=for-rent&sort=date_desc" class="btn-subtle cta-fluid shrink-0 whitespace-nowrap">See more</a>
        </header>
        <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-10">
          {secFeaturedNew.map(e => (<li><PropertyCard listing={e.data} slug={e.slug} /></li>))}
        </ul>
      </>
    )}

    {secAffordable.length > 0 && (
      <>
        <header class="landing-head mb-3">
          <h2 class="landing-h2">Affordable (≤ KSh 150k)</h2>
          <a href="/listings?availability=for-rent" class="btn-subtle cta-fluid shrink-0 whitespace-nowrap">See all affordable</a>
        </header>
        <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-10">
          {secAffordable.map(e => (<li><PropertyCard listing={e.data} slug={e.slug} /></li>))}
        </ul>
      </>
    )}

    {secPremium.length > 0 && (
      <>
        <header class="landing-head mb-3">
          <h2 class="landing-h2">Premium (≥ KSh 250k)</h2>
          <a href="/listings?availability=for-rent" class="btn-subtle cta-fluid shrink-0 whitespace-nowrap">See all premium</a>
        </header>
        <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {secPremium.map(e => (<li><PropertyCard listing={e.data} slug={e.slug} /></li>))}
        </ul>
      </>
    )}
  </section>
</MainLayout>

<!-- Cosmetic: ensure URL shows ?availability=for-rent for share/back/forward context -->
<script is:inline>
  (function () {
    try {
      const u = new URL(window.location.href);
      if (u.searchParams.get('availability') !== 'for-rent') {
        u.searchParams.set('availability', 'for-rent');
        history.replaceState({}, '', u);
      }
    } catch {}
  })();
</script>
