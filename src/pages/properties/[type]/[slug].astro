---
import { getCollection } from 'astro:content';
import MainLayout from '../../../layouts/MainLayout.astro';
import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { withV } from '../../../lib/assets';
import InquiryForm from '../../../components/forms/InquiryForm.astro';

export const prerender = true;

export async function getStaticPaths() {
  const listings = await getCollection('listings');
  return listings.map((entry) => {
    const type = (entry.data.availability || '').toLowerCase().replace(/\s+/g, '-');
    return { params: { type, slug: entry.slug } };
  });
}

const { type, slug } = Astro.params;
const norm = (s: string = '') => s.toLowerCase().replace(/\s+/g, '-');

const all = await getCollection('listings');
const entry = all.find((e) => e.slug === slug && norm(e.data.availability || '') === type);
const data = entry?.data as any | undefined;
const notFound = !entry;

/* Canonicalize /properties/{availability}/{slug} */
if (!notFound) {
  const canonicalType = norm(data?.availability || '');
  if (canonicalType && canonicalType !== type) {
    return Astro.redirect(`/properties/${canonicalType}/${slug}`, 301);
  }
}

/* Images: prefer public folder scan then frontmatter fallbacks */
let images: string[] = [];
try {
  const folder = (data?.imagesFolder || '').replace(/^\/+/, '');
  if (folder) {
    const publicDirUrl = new URL('../../../../public/', import.meta.url);
    const publicDir = fileURLToPath(publicDirUrl);
    const dir = path.join(publicDir, folder);

    if (fs.existsSync(dir)) {
      const files = fs
        .readdirSync(dir)
        .filter((f) => /\.(webp|jpg|jpeg|png)$/i.test(f))
        .sort((a, b) => {
          const ah = /hero\./i.test(a) ? 0 : 1;
          const bh = /hero\./i.test(b) ? 0 : 1;
          if (ah !== bh) return ah - bh;
          return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
        });
      images = files.map((f) => `/${folder}/${f}`);
    }
  }
} catch {}

if (!Array.isArray(images) || images.length === 0) {
  images =
    (Array.isArray(data?.images) && data.images.length > 0)
      ? data.images
      : [data?.heroImage ?? '/images/placeholder.webp'];
}
images = images.map(withV);

/* Derived fields & SEO */
const priceNumber: number | undefined = typeof data?.price === 'number' ? data.price : undefined;
const priceText = typeof data?.price === 'number' ? `KSh ${data.price.toLocaleString()}` : 'N/A';

const avail = (data?.availability || '').toLowerCase();
const serviceType =
  avail.includes('rent') ? 'rent' :
  avail.includes('sale') ? 'sale' : 'short-stays';

const isRent = avail.includes('rent');
const isSale = avail.includes('sale');

/* Inquiry context + listing info */
const inquiryContext: 'for-rent' | 'for-sale' | 'short-stay' =
  isRent ? 'for-rent' : (isSale ? 'for-sale' : 'short-stay');
const listingId = slug as string;
const listingTitle = String(data?.title || '');
const enquireLabel = 'Enquire';

/* Secondary routing */
const listHref =
  serviceType === 'rent' ? '/for-rent' :
  serviceType === 'sale' ? '/for-sale' : '/short-stays';

const badgeClass =
  avail.includes('rent') ? 'bg-emerald-600' :
  avail.includes('sale') ? 'bg-blue-600'  : 'bg-neutral-800';

/* Helpers */
const fmtPrice = (n: any) => typeof n === 'number' ? `KSh ${n.toLocaleString()}` : 'N/A';
const arr = (x: any) => Array.isArray(x) ? x : [];
const intersectCount = (a: any[], b: any[]) => {
  const setB = new Set((b || []).map((x) => String(x).toLowerCase()));
  return (a || []).reduce((acc, v) => acc + (setB.has(String(v).toLowerCase()) ? 1 : 0), 0);
};

/* Related listings */
const pool = notFound ? [] : all.filter(
  (e) => e.slug !== slug && norm(e.data.availability || '') === norm(data?.availability || '')
);

function score(candidate: any, current: any) {
  let s = 0;
  if ((candidate.location || '').toLowerCase() === (current.location || '').toLowerCase()) s += 40;
  if ((candidate.type || '').toLowerCase() === (current.type || '').toLowerCase()) s += 20;
  const cb = typeof candidate.bedrooms === 'number' ? candidate.bedrooms : undefined;
  const tb = typeof current.bedrooms === 'number' ? current.bedrooms : undefined;
  if (typeof cb === 'number' && typeof tb === 'number' && Math.abs(cb - tb) <= 1) s += 15;
  const cp = typeof candidate.price === 'number' ? candidate.price : undefined;
  const tp = typeof current.price === 'number' ? current.price : undefined;
  if (typeof cp === 'number' && typeof tp === 'number') {
    if (cp >= tp * 0.8 && cp <= tp * 1.2) s += 15;
  }
  if (intersectCount(arr(candidate.amenities), arr(current.amenities)) >= 2) s += 10;
  const cn = arr(candidate.neighborhoodHighlights || candidate.neighborhood || candidate.nearby);
  const tn = arr(current.neighborhoodHighlights || current.neighborhood || current.nearby);
  if (intersectCount(cn, tn) > 0) s += 5;
  return s;
}

const related = pool
  .map((e) => ({ e, s: score(e.data, data) }))
  .sort((a, b) => b.s - a.s || (b.e.data?.date || 0) - (a.e.data?.date || 0))
  .slice(0, 4)
  .map((x) => x.e);

/* Optional rich media */
const videoUrl = data?.videoUrl as string | undefined;
const isYouTube = typeof videoUrl === 'string' && /youtube\.com|youtu\.be/.test(videoUrl);
const isVimeo = typeof videoUrl === 'string' && /vimeo\.com/.test(videoUrl);

/* Content blocks */
const amenitiesArr: string[] = Array.isArray(data?.amenities) ? data.amenities : [];
const amenitiesCategories = (data as any)?.amenitiesCategories as Record<string, string[]> | undefined;

const neighborhood: string[] =
  (Array.isArray(data?.neighborhoodHighlights) && data.neighborhoodHighlights) ||
  (Array.isArray(data?.neighborhood) && data.neighborhood) ||
  (Array.isArray(data?.nearby) && data.nearby) || [];

const neighborhoodCategories =
  ((data as any)?.neighborhoodCategories || (data as any)?.neighborhoodByType) as Record<string, string[]> | undefined;

const features: string[] = Array.isArray((data as any)?.features) ? (data as any).features : [];

/* Canonical */
const canonicalPath = notFound ? '/properties' : `/properties/${norm(data?.availability || '')}/${slug}`;
const canonicalUrl = Astro.site ? new URL(canonicalPath, Astro.site).toString() : canonicalPath;

/* Share URLs */
const enc = encodeURIComponent;
const share = {
  fb: `https://www.facebook.com/sharer/sharer.php?u=${enc(canonicalUrl)}`,
  x: `https://twitter.com/intent/tweet?url=${enc(canonicalUrl)}&text=${enc(data?.title || '')}`,
  li: `https://www.linkedin.com/sharing/share-offsite/?url=${enc(canonicalUrl)}`,
  wa: `https://wa.me/?text=${enc((data?.title || '') + ' ' + canonicalUrl)}`,
  em: `mailto:?subject=${enc(data?.title || '')}&body=${enc((data?.title || '') + '\n' + canonicalUrl)}`,
  sms:`sms:?&body=${enc((data?.title || '') + ' ' + canonicalUrl)}`
};

/* JSON-LD + breadcrumb (All Listings) */
const offerAvailability =
  avail.includes('rent') || avail.includes('sale')
    ? 'https://schema.org/InStock'
    : 'https://schema.org/PreOrder';

const listingType = (data?.type || 'Residence').toLowerCase();
const schemaResidenceType =
  listingType.includes('apartment') ? 'Apartment' :
  listingType.includes('villa')     ? 'House'     :
  listingType.includes('house')     ? 'House'     :
  listingType.includes('studio')    ? 'Apartment' :
  listingType.includes('commercial')? 'Place'     : 'Residence';

const realEstateLD = notFound ? null : {
  '@context': 'https://schema.org',
  '@type': 'RealEstateListing',
  name: data?.title,
  description: data?.description || `${data?.title} in ${data?.location}`,
  url: canonicalUrl,
  image: images,
  address: {
    '@type': 'PostalAddress',
    addressLocality: data?.location || 'Nairobi',
    addressCountry: 'KE'
  },
  itemOffered: {
    '@type': schemaResidenceType,
    name: data?.title,
    numberOfRoomsTotal: data?.bedrooms || undefined,
    numberOfBathroomsTotal: data?.bathrooms || undefined
  },
  offers: {
    '@type': 'Offer',
    price: priceNumber,
    priceCurrency: 'KES',
    availability: offerAvailability,
    url: canonicalUrl
  }
};

const breadcrumbLD = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: Astro.site ? new URL('/', Astro.site).toString() : '/' },
    { '@type': 'ListItem', position: 2, name: 'All Listings', item: Astro.site ? new URL('/listings', Astro.site).toString() : '/listings' },
    !notFound && { '@type': 'ListItem', position: 3, name: data?.availability, item: Astro.site ? new URL(listHref, Astro.site).toString() : listHref },
    !notFound && { '@type': 'ListItem', position: 4, name: data?.title, item: canonicalUrl },
  ].filter(Boolean)
};

/* CTAs: WhatsApp preserved */
const BUSINESS_PHONE = import.meta.env.PUBLIC_BUSINESS_PHONE || '';
const waText = `Hello, I'm interested in ${data?.title || 'the listing'} – ${canonicalUrl}`;
const waHref  = BUSINESS_PHONE ? `https://wa.me/${BUSINESS_PHONE.replace(/\D/g,'')}?text=${enc(waText)}` : '';
const waUiHref = waHref || share.wa;

/* Investor signal */
const marketRent = typeof (data as any)?.marketRent === 'number' ? (data as any).marketRent : undefined;
const grossYield = (marketRent && typeof data?.price === 'number') ? ((marketRent * 12) / data.price * 100) : undefined;

/* Description segmentation */
const fullDesc: string = String(data?.description || '');
const sentences = fullDesc.split(/(?<=[.!?])\s+/).filter(Boolean);
const descCount = Math.min(Math.max(3, sentences.length), 5);
const shortDesc = sentences.slice(0, descCount).join(' ');
---

<MainLayout
  title={notFound ? 'Listing Not Found – Severino Realty' : `${data.title} – Severino Realty`}
  description={notFound ? 'We could not find the property you are looking for.' : `${data.title} in ${data.location}`}
  seoImage={images[0] || '/images/placeholder.webp'}
>
  <link rel="canonical" href={canonicalUrl} />

  {!notFound && (
    <>
      <script type="application/ld+json" is:inline>{JSON.stringify(realEstateLD)}</script>
      <script type="application/ld+json" is:inline>{JSON.stringify(breadcrumbLD)}</script>
    </>
  )}

  {notFound ? (
    <section class="py-16 px-4 text-center max-w-3xl mx-auto">
      <h1 class="text-3xl font-bold text-primary mb-4">Listing Not Found</h1>
      <a href="/for-rent" class="inline-block bg-cta text-white px-6 py-3 rounded-md">Browse Properties</a>
    </section>
  ) : (
    <>
      <!-- BREADCRUMB -->
      <nav class="max-w-6xl mx-auto px-4 py-3 text-sm">
        <ol class="flex flex-wrap items-center gap-x-2 gap-y-1 rounded-md bg-neutral-50 ring-1 ring-neutral-200 px-3 py-2">
          <li><a href="/" class="link-decor text-neutral-700 hover:text-cta">Home</a></li>
          <li class="text-neutral-400">/</li>
          <li><a href="/listings" class="link-decor text-neutral-700 hover:text-cta">All Listings</a></li>
          <li class="text-neutral-400">/</li>
          <li><a href={listHref} class="link-decor text-neutral-700 hover:text-cta capitalize">{isSale ? 'For Sale' : isRent ? 'For Rent' : 'Short Stays'}</a></li>
          <li class="text-neutral-400">/</li>
          <li class="text-neutral-800">{data.title}</li>
        </ol>
      </nav>

      <!-- HERO / CAROUSEL -->
      <section class="relative">
        <div id="carousel" class="relative aspect-[16/9] max-h-[70vh] overflow-hidden bg-black" aria-label="Property images" role="region">
          {images.map((src, idx) => (
            <img
              src={src}
              alt={data.title}
              class="absolute inset-0 h-full w-full object-cover transition-opacity duration-700"
              style={`opacity:${idx === 0 ? '1' : '0'}`}
              loading={idx === 0 ? 'eager' : 'lazy'}
            />
          ))}

          <button id="prev" class="carousel-btn absolute left-3 top-1/2 -translate-y-1/2" aria-label="Previous image">‹</button>
          <button id="next" class="carousel-btn absolute right-3 top-1/2 -translate-y-1/2" aria-label="Next image">›</button>

          <div id="dots" class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2" aria-label="Select image">
            {images.map((_, i) => (
              <button class={`h-2.5 w-2.5 rounded-full ${i === 0 ? 'bg-white' : 'bg-white/60'}`} aria-label={`Go to image ${i+1}`}></button>
            ))}
          </div>

          <div id="count" class="absolute bottom-3 right-3 text-xs text-white/90 bg-black/40 px-2 py-1 rounded">
            1 / {images.length}
          </div>

          <div id="swipe-hint" class="absolute bottom-14 left-1/2 -translate-x-1/2 text-[11px] text-white/90 bg-black/40 px-2 py-1 rounded pointer-events-none">
            ‹ › swipe
          </div>

          <button id="zoom-open" class="absolute inset-0" aria-label="Open image in full-screen"></button>
        </div>
      </section>

      <!-- HEADER / PRIMARY FACTS + CTAs -->
      <section class="max-w-6xl mx-auto px-4 py-8">
        <div class="flex flex-wrap items-start gap-3">
          <span class={`text-xs text-white px-2 py-1 rounded ${badgeClass}`} aria-label="Availability">{data.availability}</span>
          <h1 class="text-2xl md:text-3xl font-semibold">{data.title}</h1>
        </div>
        <p class="mt-1 text-neutral-700">{data.location}</p>

        <div class="mt-4 flex flex-wrap items-center gap-3">
          <span class="text-xl font-bold text-cta">{priceText}</span>
          {data.area && <span class="fact-label">{data.area}</span>}

          <!-- Desktop/tablet: Enquire + WhatsApp -->
          <a
            href="#"
            data-inquiry-trigger
            data-context={inquiryContext}
            data-id={listingId}
            data-title={listingTitle}
            class="ml-auto hidden sm:inline-flex bg-cta text-white px-5 py-2 rounded-md"
            aria-label={enquireLabel}
          >
            {enquireLabel}
          </a>
          <a href={waUiHref} class="hidden sm:inline-flex btn-wa px-4 py-2 rounded-md" aria-label="Chat on WhatsApp" data-track="wa_click">
            WhatsApp
          </a>

          <!-- Mobile: Enquire + WhatsApp -->
          <div class="w-full sm:hidden flex items-center gap-2 mt-2">
            <a
              href="#"
              data-inquiry-trigger
              data-context={inquiryContext}
              data-id={listingId}
              data-title={listingTitle}
              class="flex-1 bg-primary text-white px-4 py-2 rounded-md"
              aria-label={enquireLabel}
            >
              {enquireLabel}
            </a>
            <a href={waUiHref} aria-label="WhatsApp" class="inline-flex items-center justify-center w-10 h-10 rounded-full text-white shadow focus:outline-none focus:ring-2 focus:ring-[#25D366]" style="background:#25D366" data-track="wa_click">
              <svg viewBox="0 0 32 32" width="18" height="18" fill="currentColor" aria-hidden="true"><path d="M19.11 17.41c-.27-.14-1.57-.77-1.82-.85-.24-.09-.42-.14-.6.14-.17.27-.68.85-.83 1.02-.15.17-.31.2-.58.07-.27-.14-1.14-.42-2.18-1.34-.8-.71-1.34-1.58-1.5-1.85-.16-.27-.02-.42.12-.56.12-.12.27-.31.4-.46.14-.15.18-.25.27-.42.09-.17.05-.31-.02-.45-.07-.14-.6-1.44-.82-1.97-.22-.53-.44-.46-.6-.46-.16 0-.34-.02-.52-.02-.18 0-.45.07-.68.31-.24.24-.89.87-.89 2.11 0 1.24.91 2.44 1.04 2.61.12.17 1.79 2.73 4.33 3.82.61.26 1.08.42 1.45.54.61.19 1.17.16 1.61.1.49-.07 1.57-.64 1.79-1.26.22-.62.22-1.15.15-1.26-.07-.11-.24-.18-.51-.32z"/><path d="M26.7 5.3C24.1 2.7 20.65 1.3 17 1.3 9.94 1.3 4.3 6.94 4.3 14c0 2.25.59 4.45 1.71 6.39L4 28l7.79-2c1.84 1 3.92 1.52 6.04 1.52 7.06 0 12.7-5.64 12.7-12.7 0-3.38-1.32-6.56-3.83-9.08zM17.83 25.3c-1.87 0-3.69-.5-5.28-1.45l-.38-.23-4.63 1.19 1.24-4.51-.25-.38C7.43 18.2 6.9 16.13 6.9 14 6.9 8.49 11.49 3.9 17 3.9c3.09 0 6 .1 8.2 2.31 2.2 2.2 3.5 5.12 3.5 8.2 0 6.51-4.59 11.9-10.87 10.89z"/></svg>
            </a>
          </div>
        </div>

        <!-- SHARE -->
        <div class="mt-4 share-bar" aria-label="Share this listing">
          <span class="share-label">Share:</span>
          <div class="relative inline-block">
            <button id="share-trigger" class="share-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="share-pop">Share</button>
            <div id="share-pop" class="hidden absolute left-0 mt-2 w-56 bg-white ring-1 ring-neutral-200 rounded-md shadow-lg p-2 z-20" role="menu" aria-label="Share options">
              <div class="grid grid-cols-2 gap-2">
                <a class="share-btn justify-center" href={share.fb} target="_blank" rel="noopener">Facebook</a>
                <a class="share-btn justify-center" href={share.x}  target="_blank" rel="noopener">X</a>
                <a class="share-btn justify-center" href={share.li} target="_blank" rel="noopener">LinkedIn</a>
                <a class="share-btn justify-center" href={share.wa} target="_blank" rel="noopener">WhatsApp</a>
                <a class="share-btn justify-center" href={share.em}>Email</a>
                <a class="share-btn justify-center" href={share.sms}>Text</a>
              </div>
              <button id="share-copy" class="share-btn w-full mt-2" type="button">Copy link</button>
            </div>
          </div>
        </div>
      </section>

      <!-- DETAILS GRID -->
      <section class="max-w-6xl mx-auto px-4 grid md:grid-cols-3 gap-8 pb-24 md:pb-10">
        <article class="md:col-span-2 space-y-6">
          {fullDesc && (
            <div class="card p-4 space-y-2">
              <h2 class="text-lg font-semibold">Property Description</h2>
              <p class="leading-relaxed text-neutral-800">{shortDesc}</p>
            </div>
          )}

          {features.length > 0 && (
            <div class="card p-4 space-y-2">
              <h2 class="text-lg font-semibold">Key Features</h2>
              <ul class="grid md:grid-cols-2 gap-x-8 gap-y-1 list-disc pl-5">
                {features.slice(0, 8).map((f) => <li>{f}</li>)}
              </ul>
            </div>
          )}

          {(amenitiesCategories && Object.keys(amenitiesCategories).length > 0) ? (
            <div class="card p-4 space-y-3">
              <h2 class="text-lg font-semibold">Amenities</h2>
              <div class="grid md:grid-cols-2 gap-6">
                {Object.entries(amenitiesCategories).map(([cat, items]) => (
                  <div>
                    <h3 class="text-sm text-primary mb-1">{cat}</h3>
                    <ul class="list-disc pl-5 space-y-1">
                      {items.map((x) => <li>{x}</li>)}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            amenitiesArr.length > 0 && (
              <div class="card p-4 space-y-2">
                <h2 class="text-lg font-semibold">Amenities</h2>
                <ul class="grid md:grid-cols-2 gap-x-8 gap-y-1 list-disc pl-5">
                  {amenitiesArr.map((a) => <li>{a}</li>)}
                </ul>
              </div>
            )
          )}

          {(neighborhoodCategories && Object.keys(neighborhoodCategories).length > 0) ? (
            <div class="card p-4 space-y-3">
              <h2 class="text-lg font-semibold">Neighborhood Highlights</h2>
              <div class="grid md:grid-cols-3 gap-6">
                {Object.entries(neighborhoodCategories).map(([cat, items]) => (
                  <div>
                    <h3 class="text-sm text-primary mb-1">{cat}</h3>
                    <ul class="list-disc pl-5 space-y-1">
                      {items.slice(0, 8).map((x) => <li>{x}</li>)}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            neighborhood.length > 0 && (
              <div class="card p-4 space-y-2">
                <h2 class="text-lg font-semibold">Neighborhood Highlights</h2>
                <ul class="grid md:grid-cols-2 gap-x-8 gap-y-1 list-disc pl-5">
                  {neighborhood.slice(0, 8).map((x) => <li>{x}</li>)}
                </ul>
              </div>
            )
          )}

          {(data?.deposit || data?.serviceCharge || data?.utilitiesIncluded !== undefined || data?.petsAllowed !== undefined) && (
            <div class="card p-4 space-y-2">
              <h2 class="text-lg font-semibold">Fees & Policies</h2>
              <ul class="list-disc pl-5 space-y-1 text-neutral-800">
                {data?.deposit && <li>Deposit: {fmtPrice(data.deposit)}</li>}
                {data?.serviceCharge && <li>Service Charge: {fmtPrice(data.serviceCharge)}/mo</li>}
                {data?.utilitiesIncluded !== undefined && <li>Utilities: {data.utilitiesIncluded ? 'Included' : 'Pay as per use'}</li>}
                {data?.petsAllowed !== undefined && <li>Pets: {data.petsAllowed ? 'Allowed' : 'Not allowed'}</li>}
              </ul>
            </div>
          )}

          {Array.isArray(data?.floorPlans) && data.floorPlans.length > 0 && (
            <div class="card p-4 space-y-2">
              <h2 class="text-lg font-semibold">Documents</h2>
              <ul class="list-disc pl-5 space-y-1">
                {data.floorPlans.map((f: string) => (
                  <li><a href={withV(f)} class="text-primary underline" target="_blank" rel="noopener">Floor plan</a></li>
                ))}
              </ul>
            </div>
          )}

          {videoUrl && (
            <div class="aspect-video w-full card p-0">
              {isYouTube ? (
                <iframe
                  src={`https://www.youtube.com/embed/${videoUrl.split('v=')[1] || ''}`}
                  class="h-full w-full"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Listing video"
                />
              ) : isVimeo ? (
                <iframe
                  src={videoUrl.replace('vimeo.com', 'player.vimeo.com/video')}
                  class="h-full w-full"
                  allow="autoplay; fullscreen; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                  title="Listing video"
                />
              ) : (
                <video controls class="h-full w-full">
                  <source src={videoUrl} />
                </video>
              )}
            </div>
          )}
        </article>

        <aside class="space-y-4">
          <div class="rounded-xl border p-4 card">
            <h3 class="font-semibold mb-2">Quick Facts</h3>
            <ul class="space-y-1 text-sm text-neutral-700">
              <li><strong>{isRent ? 'Monthly Rent' : 'Price'}:</strong> {priceText}</li>
              <li><strong>Type:</strong> {data.type ?? '—'}</li>
              <li><strong>Bedrooms:</strong> {data.bedrooms ?? '—'}</li>
              <li><strong>Bathrooms:</strong> {data.bathrooms ?? '—'}</li>
              {data.parking && <li><strong>Parking:</strong> {data.parking}</li>}
              {data.location && <li><strong>Location:</strong> {data.location}</li>}
              {data.condition && <li><strong>Condition:</strong> {data.condition}</li>}
              {data.serviceCharge && <li><strong>Service Charge:</strong> {fmtPrice(data.serviceCharge)}/mo</li>}
              {data.titleStatus && <li><strong>Title Status:</strong> {data.titleStatus}</li>}
              {isSale && data.tenure && <li><strong>Tenure:</strong> {data.tenure}{data.tenureYears ? ` (${data.tenureYears} yrs)` : ''}</li>}
              {data.floor && <li><strong>Floor:</strong> {data.floor}</li>}
              {isRent && data.deposit && <li><strong>Deposit:</strong> {fmtPrice(data.deposit)}</li>}
              {isRent && (data.utilitiesIncluded !== undefined) && (
                <li><strong>Utilities:</strong> {data.utilitiesIncluded ? 'Included' : 'Pay as per use'}</li>
              )}
              {data.furnishing && <li><strong>Furnishing:</strong> {data.furnishing}</li>}
              {data.internet && <li><strong>Internet:</strong> {data.internet}</li>}
              {data.security && <li><strong>Security:</strong> {data.security}</li>}
              {data.availabilityDate && <li><strong>Available:</strong> {data.availabilityDate}</li>}
              {data.petsAllowed !== undefined && <li><strong>Pets:</strong> {data.petsAllowed ? 'Allowed' : 'Not allowed'}</li>}
              {data.ref && <li><strong>Ref ID:</strong> {data.ref}</li>}
              {grossYield && <li><strong>Est. Gross Yield:</strong> {grossYield.toFixed(1)}%</li>}
            </ul>
          </div>
        </aside>
      </section>

      <!-- RELATED -->
      {related.length > 0 && (
        <section class="max-w-6xl mx-auto px-4 pb-16">
          <h2 class="text-xl font-semibold mb-4">You Might Also Like</h2>
          <div class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {related.map((e) => {
              const href = `/properties/${norm(e.data.availability || '')}/${e.slug}`;
              const img = (e.data.heroImage || e.data.images?.[0] || '/images/placeholder.webp');
              const price = fmtPrice(e.data.price);
              return (
                <a href={href} class="block rounded-xl overflow-hidden border hover:shadow focus:outline-none focus:ring-2 focus:ring-cta">
                  <img src={withV(img)} alt={e.data.title} class="h-40 w-full object-cover" loading="lazy" />
                  <div class="p-3 space-y-0.5">
                    <p class="text-sm font-semibold">{price}</p>
                    <p class="text-xs text-neutral-700">
                      {(e.data.bedrooms ?? '—')} bd • {(e.data.bathrooms ?? '—')} ba{e.data.area ? ` • ${e.data.area}` : ''}
                    </p>
                    <h3 class="font-medium">{e.data.title}</h3>
                    <p class="text-sm">{e.data.location}</p>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      )}

      <!-- MOBILE STICKY CTA BAR -->
      <div class="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white/95 backdrop-blur border-t safe-bottom">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
          <div class="flex-1 min-w-0">
            <div class="text-sm text-neutral-700 truncate">{data.title}</div>
            <div class="text-base font-semibold">{priceText}</div>
          </div>
          <a
            href="#"
            data-inquiry-trigger
            data-context={inquiryContext}
            data-id={listingId}
            data-title={listingTitle}
            class="btn-cta rounded-md px-3 py-2"
            aria-label={enquireLabel}
          >
            {enquireLabel}
          </a>
          <a href={waUiHref} aria-label="WhatsApp" class="inline-flex items-center justify-center w-10 h-10 rounded-full text-white shadow focus:outline-none focus:ring-2 focus:ring-[#25D366]" style="background:#25D366" data-track="wa_click">
            <svg viewBox="0 0 32 32" width="18" height="18" fill="currentColor" aria-hidden="true"><path d="M19.11 17.41c-.27-.14-1.57-.77-1.82-.85-.24-.09-.42-.14-.6.14-.17.27-.68.85-.83 1.02-.15.17-.31.2-.58.07-.27-.14-1.14-.42-2.18-1.34-.8-.71-1.34-1.58-1.5-1.85-.16-.27-.02-.42.12-.56.12-.12.27-.31.4-.46.14-.15.18-.25.27-.42.09-.17.05-.31-.02-.45-.07-.14-.6-1.44-.82-1.97-.22-.53-.44-.46-.6-.46-.16 0-.34-.02-.52-.02-.18 0-.45.07-.68.31-.24.24-.89.87-.89 2.11 0 1.24.91 2.44 1.04 2.61.12.17 1.79 2.73 4.33 3.82.61.26 1.08.42 1.45.54.61.19 1.17.16 1.61.1.49-.07 1.57-.64 1.79-1.26.22-.62.22-1.15.15-1.26-.07-.11-.24-.18-.51-.32z"/><path d="M26.7 5.3C24.1 2.7 20.65 1.3 17 1.3 9.94 1.3 4.3 6.94 4.3 14c0 2.25.59 4.45 1.71 6.39L4 28l7.79-2c1.84 1 3.92 1.52 6.04 1.52 7.06 0 12.7-5.64 12.7-12.7 0-3.38-1.32-6.56-3.83-9.08zM17.83 25.3c-1.87 0-3.69-.5-5.28-1.45l-.38-.23-4.63 1.19 1.24-4.51-.25-.38C7.43 18.2 6.9 16.13 6.9 14 6.9 8.49 11.49 3.9 17 3.9c3.09 0 6 .1 8.2 2.31 2.2 2.2 3.5 5.12 3.5 8.2 0 6.51-4.59 11.9-10.87 10.89z"/></svg>
          </a>
        </div>
      </div>

      <!-- INQUIRY MODAL -->
      <dialog id="inquiry-modal" class="rounded-2xl p-0 backdrop:bg-black/40">
        <div class="relative max-w-2xl">
          <button data-action="close" class="absolute right-2 top-2 rounded-md px-2 py-1 text-sm">Close</button>
          <InquiryForm context={inquiryContext} listingId={listingId} listingTitle={listingTitle} />
        </div>
      </dialog>
    </>
  )}
</MainLayout>

<!-- Carousel + Share + Inquiry opener -->
<script is:inline>
(function(){
  /* -------- Carousel -------- */
  const root = document.getElementById('carousel');
  if (root) {
    const slides = Array.from(root.querySelectorAll('img'));
    const dotsWrap = document.getElementById('dots');
    const dots = dotsWrap ? Array.from(dotsWrap.querySelectorAll('button')) : [];
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const count = document.getElementById('count');
    const zoomOpen = document.getElementById('zoom-open');
    const swipeHint = document.getElementById('swipe-hint');

    let i = 0, t;
    const updateCount = () => { if (count) count.textContent = (i+1) + ' / ' + slides.length; };
    const show = (n) => {
      i = (n + slides.length) % slides.length;
      slides.forEach((img, idx) => img.style.opacity = idx === i ? '1' : '0');
      dots.forEach((d, idx) => d.className = 'h-2.5 w-2.5 rounded-full ' + (idx===i ? 'bg-white' : 'bg-white/60'));
      updateCount();
    };
    const start = () => { stop(); t = setInterval(()=>show(i+1), 4500); };
    const stop  = () => { if (t) clearInterval(t); };

    prev && prev.addEventListener('click', () => { show(i-1); start(); });
    next && next.addEventListener('click', () => { show(i+1); start(); });
    dots.forEach((d, idx) => d.addEventListener('click', () => { show(idx); start(); }));

    let sx=0;
    root.addEventListener('touchstart', e=>{ sx = e.touches[0].clientX; stop(); }, {passive:true});
    root.addEventListener('touchend', e=>{
      const dx = e.changedTouches[0].clientX - sx;
      if (Math.abs(dx) > 40) show(i + (dx<0?1:-1));
      start();
    }, {passive:true});

    document.addEventListener('keydown', (e)=>{
      if (document.activeElement && /input|textarea|select/i.test(document.activeElement.tagName)) return;
      if (e.key === 'ArrowLeft') { show(i-1); start(); }
      if (e.key === 'ArrowRight') { show(i+1); start(); }
    });

    const hideHint = () => { if (swipeHint) swipeHint.style.display = 'none'; };
    setTimeout(hideHint, 3000);
    ['click','touchstart','keydown'].forEach(ev => root.addEventListener(ev, hideHint, { once: true }));

    /* Lightbox */
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    const lbPrev = document.getElementById('lightbox-prev');
    const lbNext = document.getElementById('lightbox-next');
    const lbClose = document.getElementById('lightbox-close');
    const lbBackdrop = document.querySelector('[data-lightbox-close]');

    const lbShow = (n) => {
      i = (n + slides.length) % slides.length;
      if (lb && lbImg) {
        lbImg.setAttribute('src', slides[i].getAttribute('src') || '');
        lb.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
    };
    const lbHide = () => {
      if (lb) {
        lb.classList.add('hidden');
        document.body.style.overflow = '';
      }
    };

    zoomOpen && zoomOpen.addEventListener('click', () => lbShow(i));
    lbPrev && lbPrev.addEventListener('click', () => lbShow(i-1));
    lbNext && lbNext.addEventListener('click', () => lbShow(i+1));
    lbClose && lbClose.addEventListener('click', lbHide);
    lbBackdrop && lbBackdrop.addEventListener('click', lbHide);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') lbHide(); });

    updateCount();
    show(0);
    start();
  }

  /* -------- Share: native vs popover -------- */
  const shareTrigger = document.getElementById('share-trigger');
  const sharePop = document.getElementById('share-pop');
  const copyBtn = document.getElementById('share-copy');

  const closePop = () => { sharePop && sharePop.classList.add('hidden'); shareTrigger?.setAttribute('aria-expanded','false'); };
  const openPop  = () => { sharePop && sharePop.classList.remove('hidden'); shareTrigger?.setAttribute('aria-expanded','true'); };

  if (shareTrigger) {
    if (navigator.share) {
      shareTrigger.addEventListener('click', () => {
        navigator.share({ title: document.title, url: window.location.href }).catch(()=>{});
      });
    } else {
      shareTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        if (sharePop?.classList.contains('hidden')) openPop(); else closePop();
      });
      document.addEventListener('click', (e) => {
        if (!sharePop) return;
        if (!sharePop.contains(e.target) && e.target !== shareTrigger) closePop();
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePop(); });
    }
  }

  if (copyBtn) {
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        copyBtn.textContent = 'Copied';
        setTimeout(()=>copyBtn.textContent='Copy link', 1500);
      } catch {}
    });
  }

  /* -------- Inquiry modal: open/close (uses reusable InquiryForm component) -------- */
  const modal = document.getElementById('inquiry-modal');
  const closeBtn = modal?.querySelector('[data-action="close"]');
  const triggers = Array.from(document.querySelectorAll('[data-inquiry-trigger]'));

  const openModal = () => {
    if (!modal) return;
    if (typeof modal.showModal === 'function') {
      modal.showModal();
    } else {
      // Fallback for very old browsers
      modal.setAttribute('open', '');
    }
    // focus first input in the form
    setTimeout(() => {
      const first = modal.querySelector('#inquiry-form input, #inquiry-form textarea, #inquiry-form select');
      first && first.focus();
    }, 20);
  };

  const closeModal = () => {
    if (!modal) return;
    if (typeof modal.close === 'function') {
      modal.close();
    } else {
      modal.removeAttribute('open');
    }
  };

  triggers.forEach(el => el.addEventListener('click', (e) => { e.preventDefault(); openModal(); }));
  closeBtn && closeBtn.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
  modal && modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); }); // click backdrop
})();
</script>

<script is:inline>
  console.log('PUBLIC_BUSINESS_PHONE =', import.meta.env.PUBLIC_BUSINESS_PHONE);
</script>
