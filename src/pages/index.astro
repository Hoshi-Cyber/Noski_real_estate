---
// src/pages/index.astro
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';
import HeroBanner from '../components/HeroBanner.astro';
import HeroSearch from '../components/HeroSearch.astro';
import BlogCard from '../components/blog/BlogCard.astro';
import ResourceCard from '../components/ResourceCard.astro';
import FeaturedListingsRow from '../components/FeaturedListingsRow.astro';
import BaseCard from '../components/BaseCard.astro';
import {
  resolveListingImage,
  buildResourceHref,
  resolveResourceImage,
  buildBlogHref
} from '../lib/utils/paths';

const listings = await getCollection('listings');
const featured = await getCollection('featured');
const blog = await getCollection('blog');
const resources = await getCollection('resources');

// Blog posts
const blogSorted = [...blog].sort(
  (a, b) => new Date(b.data?.pubDate || 0).getTime() - new Date(a.data?.pubDate || 0).getTime()
);
const featuredPosts = blogSorted.slice(0, 2);
const blogFallbacks = ['/images/blog/01.webp', '/images/blog/02.webp'];
const pickBlogImg = (post: any, i: number) =>
  post?.data?.heroImage || blogFallbacks[i % blogFallbacks.length];

// Resources (latest 3 + build href/image)
const latestResources = [...resources]
  .sort(
    (a, b) => new Date(b.data?.pubDate || 0).getTime() - new Date(a.data?.pubDate || 0).getTime()
  )
  .slice(0, 3);

const resourceItems = latestResources
  .filter((r) => r?.data && r?.slug)
  .map((res) => {
    // default href from util
    let href = buildResourceHref(res as any);

    // Override specific resource to desired guides route
    // Old: /resources/guides/landlords-guide-to-hassle-free-property-management
    // New: /resources/guides/renting-landlord/hassle-free-property-management
    const slug = (res.slug || '').toLowerCase();
    const title = (res.data?.title || '').toLowerCase();
    if (
      slug.endsWith('landlords-guide-to-hassle-free-property-management') ||
      title.includes('hassle-free property management')
    ) {
      href = '/resources/guides/renting-landlord/hassle-free-property-management';
    }

    const img = resolveResourceImage(
      res.slug,
      (res.data as any)?.section,
      (res.data as any)?.imagesFolder,
      (res.data as any)?.heroImage,
      (res.data as any)?.image
    );
    const cover = (res.data as any)?.icon || img;
    return { res, href, cover };
  });

// Featured listings
const featuredItems = featured
  .map((feat) => {
    const source = listings.find((list) => list.slug === feat.slug) || feat;
    const image =
      resolveListingImage(
        source?.slug,
        source?.data?.imagesFolder,
        source?.data?.images,
        source?.data?.image
      ) || '/images/placeholder.webp';

    const availability =
      (source as any)?.data?.availability ??
      (feat as any)?.data?.availability ??
      '';

    return {
      ...feat,
      slug: source.slug,
      data: {
        ...(source as any).data,
        availability,
        image,
      },
    };
  })
  .slice(0, 4);

// Extract Areas
const allAreas = Array.from(
  new Set(
    listings.map((l) =>
      (l.data.area || (l.data.location || '').split(',')[0].trim()).toLowerCase()
    )
  )
)
  .filter(Boolean)
  .sort();

const AREAS = allAreas.slice(0, 8).map((a) => ({
  href: `/areas/${a}`,
  label: a.charAt(0).toUpperCase() + a.slice(1),
}));

// Categories
function resolveCategory(d) {
  if (d.category) return d.category.toLowerCase();
  const t = (d.type || '').toLowerCase();
  if (t.includes('land')) return 'land';
  if (t.includes('apartment') || t.includes('townhouse') || t.includes('villa') || t.includes('cabin'))
    return 'residential';
  return 'residential';
}
const allCategories = Array.from(new Set(listings.map((l) => resolveCategory(l.data)))).sort();
const TYPES = allCategories.slice(0, 8).map((c) => ({
  href: `/types/${c}`,
  label: c.charAt(0).toUpperCase() + c.slice(1),
}));

// (Non-breaking) helpers passed to HeroSearch if it supports props:
const popularAreas = AREAS.map((a) => a.label);
const propertyTypes = Array.from(
  new Set(listings.map((l) => (l.data.type || '').toLowerCase()).filter(Boolean))
).slice(0, 10);
---

<MainLayout
  title="Severino Realty – Your Trusted Real Estate Partner"
  description="Explore properties for sale, rent and short stays in Nairobi. Expert advice, guides and more."
>
  <!-- Hero -->
  <HeroBanner
    title="Luxury Villas in Karen | Secure, Private, Exclusive"
    subtitle="Curated homes with privacy, gated security, and concierge-level service."
    ctaText="View Listings"
    ctaLink="/listings"
    img="/images/hero/karen-villas.webp"
  />

  <!-- Hero Search -->
  <section class="bg-white" role="search" aria-label="Property search">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <HeroSearch areas={popularAreas} types={propertyTypes} />
    </div>
  </section>

  <!-- Featured Listings -->
  <section class="py-16 bg-neutral-50">
    <div class="container">
      <h2 class="section-title text-center mb-10">Featured Listings</h2>
      <FeaturedListingsRow items={featuredItems} />
      <div class="mt-8 flex justify-center">
        <a href="/listings" class="btn-cta rounded-full">View all listings</a>
      </div>
    </div>
  </section>

  <!-- Explore Categories -->
  <section class="relative py-16">
    <div class="absolute inset-0 -z-10 bg-gradient-to-b from-neutral-50 via-white to-neutral-50"></div>
    <div class="container">
      <h2 class="section-title">Explore Categories</h2>

      <!-- Mobile: horizontal snap-scrolling tiles -->
      <div class="md:hidden">
        <div
          id="cat-rail"
          class="cat-rail flex gap-4 overflow-x-auto px-1 pt-1 pb-2 snap-x snap-mandatory scrollbar-hide"
          role="list"
          aria-label="Browse categories"
        >
          <!-- For Sale -->
          <a href="/for-sale"
             class="category-tile tile-tint cat-tile shrink-0 w-64 snap-start focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
             role="listitem" aria-label="For Sale">
            <div class="tile-badge">
              <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12 11.2 3.05a1.125 1.125 0 0 1 1.59 0L21.75 12M4.5 9.75V20.25A1.125 1.125 0 0 0 5.625 21.375H9.75V16.5c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21.375h4.125A1.125 1.125 0 0 0 19.875 20.25V9.75"/>
              </svg>
            </div>
            <span class="tile-title">For Sale</span>
            <span class="tile-sub">Discover homes & land</span>
          </a>

          <!-- For Rent -->
          <a href="/for-rent"
             class="category-tile tile-tint cat-tile shrink-0 w-64 snap-start focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
             role="listitem" aria-label="For Rent">
            <div class="tile-badge">
              <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v9.75m0 0 3.75-3.75M12 12.75l-3.75-3.75M4.5 19.5h15"/>
              </svg>
            </div>
            <span class="tile-title">For Rent</span>
            <span class="tile-sub">Apartments & houses</span>
          </a>

          <!-- Short Stays -->
          <a href="/short-stays"
             class="category-tile tile-tint cat-tile shrink-0 w-64 snap-start focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
             role="listitem" aria-label="Short Stays">
            <div class="tile-badge">
              <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 7.5 12.75 2.25 3.75 7.5v9l9 5.25 9-5.25v-9m-9 5.25-9-5.25"/>
              </svg>
            </div>
            <span class="tile-title">Short Stays</span>
            <span class="tile-sub">Furnished options</span>
          </a>

          <!-- New Developments -->
          <a href="/developments/new/"
             class="category-tile tile-tint cat-tile shrink-0 w-64 snap-start focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
             role="listitem" aria-label="New Developments">
            <div class="tile-badge">
              <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 21h18M4.5 17.25h15M6 13.5h12M7.5 9.75h9M9 6h6"/>
              </svg>
            </div>
            <span class="tile-title">New Developments</span>
            <span class="tile-sub">Off-plan & launches</span>
          </a>

          <!-- Unfinished Projects -->
          <a href="/developments/unfinished/"
             class="category-tile tile-tint cat-tile shrink-0 w-64 snap-start focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
             role="listitem" aria-label="Unfinished Projects">
            <div class="tile-badge">
              <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12M6 12h12"/>
              </svg>
            </div>
            <span class="tile-title">Unfinished Projects</span>
            <span class="tile-sub">Complete & customize</span>
          </a>
        </div>
      </div>

      <!-- md+ : 5-column grid -->
      <div class="hidden md:grid grid-cols-5 gap-6">
        <a href="/for-sale" class="category-tile tile-tint cat-tile focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <div class="tile-badge">
            <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12 11.2 3.05a1.125 1.125 0 0 1 1.59 0L21.75 12M4.5 9.75V20.25A1.125 1.125 0 0 0 5.625 21.375H9.75V16.5c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21.375h4.125A1.125 1.125 0 0 0 19.875 20.25V9.75"/>
            </svg>
          </div>
          <span class="tile-title">For Sale</span>
          <span class="tile-sub">Discover homes & land</span>
        </a>

        <a href="/for-rent" class="category-tile tile-tint cat-tile focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <div class="tile-badge">
            <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v9.75m0 0 3.75-3.75M12 12.75l-3.75-3.75M4.5 19.5h15"/>
            </svg>
          </div>
          <span class="tile-title">For Rent</span>
          <span class="tile-sub">Apartments & houses</span>
        </a>

        <a href="/short-stays" class="category-tile tile-tint cat-tile focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <div class="tile-badge">
            <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 7.5 12.75 2.25 3.75 7.5v9l9 5.25 9-5.25v-9m-9 5.25-9-5.25"/>
            </svg>
          </div>
          <span class="tile-title">Short Stays</span>
          <span class="tile-sub">Furnished options</span>
        </a>

        <a href="/developments/new/" class="category-tile tile-tint cat-tile focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <div class="tile-badge">
            <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 21h18M4.5 17.25h15M6 13.5h12M7.5 9.75h9M9 6h6"/>
            </svg>
          </div>
          <span class="tile-title">New Developments</span>
          <span class="tile-sub">Off-plan & launches</span>
        </a>

        <a href="/developments/unfinished/" class="category-tile tile-tint cat-tile focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <div class="tile-badge">
            <svg xmlns="http://www.w3.org/2000/svg" class="tile-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12M6 12h12"/>
            </svg>
          </div>
          <span class="tile-title">Unfinished Projects</span>
          <span class="tile-sub">Complete & customize</span>
        </a>
      </div>
    </div>
  </section>

  <!-- Explore by Area -->
  <section class="relative py-16">
    <div class="absolute inset-0 -z-10 bg-gradient-to-r from-white via-neutral-50 to-white"></div>
    <div class="container">
      <h2 class="section-title">Explore by Area</h2>

    <div class="relative">
        <div class="flex overflow-x-auto gap-4 snap-x snap-mandatory scrollbar-hide py-2" role="list" aria-label="Browse areas">
          {AREAS.map(({ href, label }) => (
            <a href={href} class="area-card flex-shrink-0 w-48 snap-center focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]" role="listitem">
              {label}
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Why Choose Us -->
  <section class="relative py-16">
    <div class="absolute inset-0 -z-10 bg-gradient-to-b from-white to-neutral-50"></div>
    <div class="container">
      <h2 class="section-title">Why Choose Us</h2>

      <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-4 text-center">
        <div class="why-card why-card--tint tint-blue">
          <svg xmlns="http://www.w3.org/2000/svg" class="why-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M3 10.5 12 3l9 7.5V21H3zM8 21v-6h8v6"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="m7.5 13.5 2 2 4-4"/>
          </svg>
          <p class="why-label mt-3">Verified Listings</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">Each property is vetted for accuracy, legality, and quality—so you only view assets worth your time.</p>
        </div>

        <div class="why-card why-card--tint tint-amber">
          <svg xmlns="http://www.w3.org/2000/svg" class="why-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 11c-2.8 0-5 2.2-5 5v3h10v-3c0-2.8-2.2-5-5-5z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M15 11V8a3 3 0 0 0-6 0v3"/>
          </svg>
          <p class="why-label mt-3">Discreet Representation</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">Confidential handling of high-value transactions. Privacy preserved at every step.</p>
        </div>

        <div class="why-card why-card--tint tint-emerald">
          <svg xmlns="http://www.w3.org/2000/svg" class="why-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M8 17h8M8 13h8M8 9h8M5 21h14M5 5h14"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="m9 13 2 2 4-4"/>
          </svg>
          <p class="why-label mt-3">Strategic Negotiation</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">Expert advocacy to secure optimal terms without compromising your objectives.</p>
        </div>

        <div class="why-card why-card--tint tint-purple">
          <svg xmlns="http://www.w3.org/2000/svg" class="why-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M7 3h7l5 5v13H7zM14 3v5h5M8 14h5M8 17h8M8 11h8"/>
          </svg>
          <p class="why-label mt-3">End-to-End Service</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">From brief to closing, we orchestrate the process for a seamless, time-efficient experience.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Knowledge Hub (Blog + Resources) -->
  <section class="section bg-neutral-50">
    <div class="container">
      <header class="hub-head">
        <h2 class="section-title">Knowledge Hub</h2>
        <p class="hub-sub">Guides, market reports, and insights to make better moves.</p>
      </header>

      <div class="hub-grid">
        <!-- Featured Blog -->
        <div>
          {featuredPosts.slice(0,1).map((p, i) => {
            const href = buildBlogHref(p.slug);
            return (
              <a href={href} class="block post-card post-card--rich hub-feature" aria-labelledby={`feat-${i}`}>
                <div class="post-media-wrap">
                  <img
                    src={pickBlogImg(p, i)}
                    alt={p.data.title}
                    class="post-media"
                    loading="lazy" decoding="async" width="1200" height="675"
                  />
                  <div class="hub-chip">Featured</div>
                </div>
                <div class="post-body">
                  <h3 id={`feat-${i}`} class="post-title">{p.data.title}</h3>
                  <p class="post-desc">{p.data.excerpt ?? p.data.description}</p>
                  <div class="post-meta">
                    <span class="hub-meta">{p.data.readingTime || '3–5 min read'}</span>
                    <span class="btn-outline">Read More</span>
                  </div>
                </div>
              </a>
            );
          })}
        </div>

        <!-- Latest Resources -->
        <div class="grid gap-4 md:gap-6">
          {resourceItems.map(({ res, href, cover }, idx) => (
            <a href={href} class="rel-card rel-card--compact hub-res block" aria-labelledby={`res-${idx}`}>
              <div class="flex items-start gap-4">
                <div class="hub-thumb" aria-hidden="true">
                  <img src={cover} alt="" class="hub-thumb__img" loading="lazy" decoding="async" width="96" height="96" />
                </div>
                <div class="min-w-0">
                  <h4 id={`res-${idx}`} class="rel-title">{res.data.title}</h4>
                  <p class="rel-desc line-clamp-2">{res.data.excerpt ?? res.data.description}</p>
                  <span class="hub-link">View Resource →</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>

      <div class="mt-10 text-center">
        <a href="/resources" class="btn-cta rounded-full cta-fluid">Explore all articles &amp; guides</a>
      </div>
    </div>
  </section>

  <!-- Testimonials: Infinite carousel (compact) -->
  <section class="py-12">
    <div class="container">
      <h2 class="section-title">What Our Clients Say</h2>

      <div id="ts-wrap" class="relative overflow-hidden">
        <div id="ts-track" class="flex gap-3 md:gap-4 will-change-transform">
          <article
            class="testimonial testimonial--tint p-3 md:p-4 w-[78%] sm:w-[52%] md:w-[30%] 2xl:w-[24%] shrink-0 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
            aria-label="Testimonial from Jane Mwangi"
          >
            <div class="t-quote w-6 h-6" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.1 4C4.8 6.2 3 9 3 12.6c0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L7.1 4zm10 0c-2.3 2.2-4.1 5-4.1 8.6 0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L17.1 4z"/>
              </svg>
            </div>
            <p class="t-text t-text--clamp text-sm">“Professional and transparent. My house sold in less than a month!”</p>
            <div class="t-meta gap-2">
              <div>
                <div class="t-author text-sm">Jane Mwangi</div>
                <div class="t-role text-xs">Home Seller</div>
              </div>
            </div>
          </article>

          <article
            class="testimonial p-3 md:p-4 w-[78%] sm:w-[52%] md:w-[30%] 2xl:w-[24%] shrink-0 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
            aria-label="Testimonial from David and Amina"
          >
            <div class="t-quote w-6 h-6" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.1 4C4.8 6.2 3 9 3 12.6c0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L7.1 4zm10 0c-2.3 2.2-4.1 5-4.1 8.6 0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L17.1 4z"/>
              </svg>
            </div>
            <p class="t-text t-text--clamp text-sm">“They found us the perfect rental in Karen with zero stress.”</p>
            <div class="t-meta gap-2">
              <div>
                <div class="t-author text-sm">David &amp; Amina</div>
                <div class="t-role text-xs">Tenants</div>
              </div>
            </div>
          </article>

          <article
            class="testimonial p-3 md:p-4 w-[78%] sm:w-[52%] md:w-[30%] 2xl:w-[24%] shrink-0 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]"
            aria-label="Testimonial from Michael Otieno"
          >
            <div class="t-quote w-6 h-6" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.1 4C4.8 6.2 3 9 3 12.6c0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L7.1 4zm10 0c-2.3 2.2-4.1 5-4.1 8.6 0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L17.1 4z"/>
              </svg>
            </div>
            <p class="t-text t-text--clamp text-sm">“Trusted partner for investment properties. Highly recommend.”</p>
            <div class="t-meta gap-2">
              <div>
                <div class="t-author text-sm">Michael Otieno</div>
                <div class="t-role text-xs">Investor</div>
              </div>
            </div>
          </article>
        </div>
      </div>

      <div class="mt-3 flex items-center justify-center gap-2">
        <button id="ts-prev" class="btn-outline rounded-full px-3 py-1 text-sm" aria-label="Previous">‹</button>
        <button id="ts-next" class="btn-outline rounded-full px-3 py-1 text-sm" aria-label="Next">›</button>
      </div>
    </div>

    <script>
      (() => {
        const wrap = document.getElementById('ts-wrap');
        const track = document.getElementById('ts-track');
        if (!wrap || !track) return;

        // Duplicate children for loop
        track.innerHTML += track.innerHTML;

        let x = 0, speed = 0.38, raf;
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        function getGapPx() {
          const cs = getComputedStyle(track);
          const g = cs.gap || cs.columnGap || '16px';
          const n = parseFloat(g);
          return Number.isFinite(n) ? n : 16;
        }

        function cardAdvanceWidth() {
          const first = track.children[0];
          if (!first) return 220;
          const rect = first.getBoundingClientRect();
          return rect.width + getGapPx();
        }

        const step = () => {
          x -= speed;
          const adv = cardAdvanceWidth();
          if (Math.abs(x) >= adv) {
            x += adv;
            track.appendChild(track.children[0]);
          }
          track.style.transform = `translate3d(${x}px,0,0)`;
          raf = requestAnimationFrame(step);
        };

        const start = () => { if (!prefersReduced) { cancelAnimationFrame(raf); raf = requestAnimationFrame(step); } };
        const stop  = () => { cancelAnimationFrame(raf); };

        start();
        wrap.addEventListener('mouseenter', stop);
        wrap.addEventListener('mouseleave', start);
        wrap.addEventListener('focusin', stop);
        wrap.addEventListener('focusout', start);
        document.addEventListener('visibilitychange', () => { document.hidden ? stop() : start(); });

        document.getElementById('ts-prev')?.addEventListener('click', () => { x += cardAdvanceWidth(); });
        document.getElementById('ts-next')?.addEventListener('click', () => { x -= cardAdvanceWidth(); });
      })();
    </script>
  </section>

  <!-- Lead Magnet -->
  <section class="py-16 max-w-3xl mx-auto">
    <div class="card p-6">
      <h3 class="font-semibold mb-3">Get first access to new listings</h3>
      <form action="/api/subscribe" method="POST" class="grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-3" aria-label="Email signup">
        <input type="email" name="email" required placeholder="you@email.com" class="input" />
        <button class="btn-cta rounded-md whitespace-nowrap">Get Alerts</button>
      </form>
      <p class="text-xs text-neutral-500 mt-2">No spam. Unsubscribe anytime.</p>
    </div>
  </section>
</MainLayout>
