---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';
import HeroBanner from '../components/HeroBanner.astro';
import HeroSearch from '../components/HeroSearch.astro';
import BlogCard from '../components/blog/BlogCard.astro';
import ResourceCard from '../components/ResourceCard.astro';
import FeaturedListingsRow from '../components/FeaturedListingsRow.astro';
import BaseCard from '../components/BaseCard.astro';
import { resolveListingImage, buildResourceHref, resolveResourceImage } from '../lib/utils/paths';

const listings = await getCollection('listings');
const featured = await getCollection('featured');
const blog = await getCollection('blog');
const resources = await getCollection('resources');

// Blog posts
const blogSorted = [...blog].sort((a, b) =>
  new Date(b.data?.pubDate || 0).getTime() - new Date(a.data?.pubDate || 0).getTime()
);
const featuredPosts = blogSorted.slice(0, 2);
const blogFallbacks = ['/images/blog/01.webp', '/images/blog/02.webp'];
const pickBlogImg = (post: any, i: number) =>
  post?.data?.heroImage || blogFallbacks[i % blogFallbacks.length];

// Resources (latest 3 + build href/image)
const latestResources = [...resources]
  .sort((a, b) =>
    new Date(b.data?.pubDate || 0).getTime() - new Date(a.data?.pubDate || 0).getTime()
  )
  .slice(0, 3);

const resourceItems = latestResources.map((res) => {
  const href = buildResourceHref(res as any);
  const img = resolveResourceImage(
    res.slug,
    (res.data as any)?.section,
    (res.data as any)?.imagesFolder,
    (res.data as any)?.heroImage,
    (res.data as any)?.image
  );
  const cover = (res.data as any)?.icon || img;
  return { res, href, cover };
});

// Featured listings
const featuredItems = featured
  .map((feat) => {
    const source = listings.find((list) => list.slug === feat.slug) || feat;
    const image =
      resolveListingImage(
        source?.slug,
        source?.data?.imagesFolder,
        source?.data?.images,
        source?.data?.image
      ) || '/images/placeholder.webp';

    return { ...feat, data: { ...feat.data, image } };
  })
  .slice(0, 4);

// Extract Areas
const allAreas = Array.from(
  new Set(
    listings.map((l) =>
      (l.data.area || (l.data.location || '').split(',')[0].trim()).toLowerCase()
    )
  )
).filter(Boolean).sort();

const AREAS = allAreas.slice(0, 8).map((a) => ({
  href: `/areas/${a}`,
  label: a.charAt(0).toUpperCase() + a.slice(1),
}));

// Categories
function resolveCategory(d) {
  if (d.category) return d.category.toLowerCase();
  const t = (d.type || '').toLowerCase();
  if (t.includes('land')) return 'land';
  if (t.includes('apartment') || t.includes('townhouse') || t.includes('villa') || t.includes('cabin'))
    return 'residential';
  return 'residential';
}
const allCategories = Array.from(new Set(listings.map((l) => resolveCategory(l.data)))).sort();
const TYPES = allCategories.slice(0, 8).map((c) => ({
  href: `/types/${c}`,
  label: c.charAt(0).toUpperCase() + c.slice(1),
}));
---

<MainLayout
  title="Severino Realty – Your Trusted Real Estate Partner"
  description="Explore properties for sale, rent and short stays in Nairobi. Expert advice, guides and more."
>
  <!-- Hero -->
  <HeroBanner
    title="Luxury Villas in Karen | Secure, Private, Exclusive"
    subtitle="Curated homes with privacy, gated security, and concierge-level service."
    ctaText="View Listings"
    ctaLink="/listings"
    img="/images/hero/karen-villas.webp"
  />

  <!-- Hero Search (clean, after hero) -->
  <section class="bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <HeroSearch />
    </div>
  </section>

  <!-- Featured Listings -->
  <section class="py-16 bg-neutral-50">
    <div class="container">
      <h2 class="section-title text-center mb-10">Featured Listings</h2>
      <FeaturedListingsRow items={featuredItems} />
      <div class="mt-8 flex justify-center">
        <a href="/listings" class="btn-cta rounded-full">View all listings</a>
      </div>
    </div>
  </section>

  <!-- Explore Categories -->
  <section class="relative py-16">
    <div class="absolute inset-0 -z-10 bg-gradient-to-b from-neutral-50 via-white to-neutral-50"></div>
    <div class="container">
      <h2 class="section-title">Explore Categories</h2>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <a href="/types/sale" class="category-tile bg-white/80 backdrop-blur-sm ring-1 ring-neutral-200 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-primary mb-3"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.125 1.125 0 011.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>
          <span class="label">For Sale</span>
        </a>

        <a href="/types/rent" class="category-tile bg-white/80 backdrop-blur-sm ring-1 ring-neutral-200 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-primary mb-3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v9.75m0 0l3.75-3.75M12 12.75l-3.75-3.75M4.5 19.5h15"/></svg>
          <span class="label">For Rent</span>
        </a>

        <a href="/types/short" class="category-tile bg-white/80 backdrop-blur-sm ring-1 ring-neutral-200 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-primary mb-3"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 7.5l-9-5.25-9 5.25m18 0v9l-9 5.25m9-14.25l-9 5.25m0 0l-9-5.25m9 5.25v9"/></svg>
          <span class="label">Short Stays</span>
        </a>
      </div>
    </div>
  </section>

  <!-- Explore by Area -->
  <section class="relative py-16">
    <div class="absolute inset-0 -z-10 bg-gradient-to-r from-white via-neutral-50 to-white"></div>
    <div class="container">
      <h2 class="section-title">Explore by Area</h2>

      <div class="relative">
        <div class="flex overflow-x-auto gap-4 snap-x snap-mandatory scrollbar-hide py-2" role="list" aria-label="Browse areas">
          {AREAS.map(({ href, label }) => (
            <a href={href} class="area-card flex-shrink-0 w-48 snap-center focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]" role="listitem">
              {label}
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Why Choose Us -->
  <section class="relative py-16">
    <div class="absolute inset-0 -z-10 bg-gradient-to-b from-white to-neutral-50"></div>
    <div class="container">
      <h2 class="section-title">Why Choose Us</h2>
      <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-4 text-center">
        <div class="why-card ring-1 ring-neutral-200 bg-white/90">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="why-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.125 1.125 0 011.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>
          <p class="why-label">Exclusive Listings</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">Curated high-value properties.</p>
        </div>

        <div class="why-card ring-1 ring-neutral-200 bg-white/90">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="why-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v4.5m6.364 1.136-3.182 3.182M21 12h-4.5m-1.136 6.364-3.182-3.182M12 21v-4.5M5.636 16.364l3.182-3.182M3 12h4.5M8.636 5.636 11.818 8.818"/></svg>
          <p class="why-label">Faster Closings</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">Streamlined and vetted.</p>
        </div>

        <div class="why-card ring-1 ring-neutral-200 bg-white/90">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="why-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-9A2.25 2.25 0 0 0 2.25 5.25v9A2.25 2.25 0 0 0 4.5 16.5H9m6.75-7.5 5.25-5.25M21 3v5.25H15.75M15 18.75a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0z"/></svg>
          <p class="why-label">Direct Owner Deals</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">Better terms, fewer layers.</p>
        </div>

        <div class="why-card ring-1 ring-neutral-200 bg-white/90">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="why-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v18h18M7.5 13.5l3 3L18 9"/></svg>
          <p class="why-label">Market Insights</p>
          <p class="mt-2 text-sm text-neutral-600 text-center">Advisory backed by data.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Knowledge Hub (Blog + Resources) -->
  <section class="py-16 bg-neutral-50">
    <div class="container">
      <h2 class="section-title">Knowledge Hub</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Featured Blog -->
        <div>
          {featuredPosts.slice(0,1).map((p, i) => (
            <div class="card overflow-hidden">
              <img 
                src={pickBlogImg(p, i)} 
                alt={p.data.title} 
                class="w-full h-56 object-cover"
                loading="lazy" decoding="async" width="880" height="224"
              />
              <div class="p-6">
                <h3 class="text-xl font-semibold text-primary mb-3">{p.data.title}</h3>
                <p class="text-neutral-600 mb-4">{p.data.excerpt}</p>
                <a href={`/blog/${p.slug}`} class="btn-outline">Read More</a>
              </div>
            </div>
          ))}
        </div>

        <!-- Latest Resources -->
        <div class="grid gap-6">
          {resourceItems.map(({ res, href, cover }) => (
            <div class="card-tight flex items-start gap-4">
              <div class="flex-shrink-0 w-20 h-20 bg-neutral-100 rounded-lg overflow-hidden">
                <img src={cover} alt={res.data.title} class="w-full h-full object-cover" loading="lazy" decoding="async" width="80" height="80" />
              </div>
              <div>
                <h4 class="font-semibold text-primary mb-1">{res.data.title}</h4>
                <p class="text-sm text-neutral-600">{res.data.excerpt}</p>
                <a href={href} class="text-cta text-sm font-medium mt-2 inline-block">
                  View Resource →
                </a>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div class="mt-10 text-center">
        <a href="/resources" class="btn-cta">Explore all articles &amp; guides</a>
      </div>
    </div>
  </section>

  <!-- Testimonials: Infinite carousel -->
  <section class="py-16">
    <div class="container">
      <h2 class="section-title">What Our Clients Say</h2>

      <div id="ts-wrap" class="relative overflow-hidden">
        <div id="ts-track" class="flex gap-4 md:gap-6 will-change-transform">
          <!-- Card 1 -->
          <article class="testimonial testimonial--tint w-[85%] sm:w-[55%] md:w-[33%] 2xl:w-[28%] shrink-0 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]" aria-label="Testimonial from Jane Mwangi">
            <div class="t-quote" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7.1 4C4.8 6.2 3 9 3 12.6c0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L7.1 4zm10 0c-2.3 2.2-4.1 5-4.1 8.6 0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L17.1 4z"/></svg>
            </div>
            <p class="t-text t-text--clamp">“Professional and transparent. My house sold in less than a month!”</p>
            <div class="t-meta">
              <div class="t-avatar" aria-hidden="true"></div>
              <div>
                <div class="t-author">Jane Mwangi</div>
                <div class="t-role">Home Seller</div>
              </div>
            </div>
          </article>

          <!-- Card 2 -->
          <article class="testimonial w-[85%] sm:w-[55%] md:w-[33%] 2xl:w-[28%] shrink-0 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]" aria-label="Testimonial from David and Amina">
            <div class="t-quote" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7.1 4C4.8 6.2 3 9 3 12.6c0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L7.1 4zm10 0c-2.3 2.2-4.1 5-4.1 8.6 0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L17.1 4z"/></svg>
            </div>
            <p class="t-text t-text--clamp">“They found us the perfect rental in Karen with zero stress.”</p>
            <div class="t-meta">
              <div class="t-avatar" aria-hidden="true"></div>
              <div>
                <div class="t-author">David &amp; Amina</div>
                <div class="t-role">Tenants</div>
              </div>
            </div>
          </article>

          <!-- Card 3 -->
          <article class="testimonial w-[85%] sm:w-[55%] md:w-[33%] 2xl:w-[28%] shrink-0 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-cta)]" aria-label="Testimonial from Michael Otieno">
            <div class="t-quote" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7.1 4C4.8 6.2 3 9 3 12.6c0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L7.1 4zm10 0c-2.3 2.2-4.1 5-4.1 8.6 0 3 2.2 5.4 5 5.4 2 0 3.6-1.7 3.6-3.7 0-2-1.6-3.6-3.6-3.6-.5 0-1 .1-1.5.3.3-2 1.6-3.9 3.3-5.3L17.1 4z"/></svg>
            </div>
            <p class="t-text t-text--clamp">“Trusted partner for investment properties. Highly recommend.”</p>
            <div class="t-meta">
              <div class="t-avatar" aria-hidden="true"></div>
              <div>
                <div class="t-author">Michael Otieno</div>
                <div class="t-role">Investor</div>
              </div>
            </div>
          </article>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-center gap-3">
        <button id="ts-prev" class="btn-outline rounded-full px-3 py-1" aria-label="Previous">‹</button>
        <button id="ts-next" class="btn-outline rounded-full px-3 py-1" aria-label="Next">›</button>
      </div>
    </div>

    <script>
      (() => {
        const wrap = document.getElementById('ts-wrap');
        const track = document.getElementById('ts-track');
        if (!wrap || !track) return;

        // Duplicate children for loop
        track.innerHTML += track.innerHTML;

        let x = 0, speed = 0.4, raf;
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        function getGapPx() {
          const cs = getComputedStyle(track);
          const g = cs.gap || cs.columnGap || '16px';
          const n = parseFloat(g);
          return Number.isFinite(n) ? n : 16;
        }

        function cardAdvanceWidth() {
          const first = track.children[0];
          if (!first) return 220;
          const rect = first.getBoundingClientRect();
          return rect.width + getGapPx();
        }

        const step = () => {
          x -= speed;
          const adv = cardAdvanceWidth();
          if (Math.abs(x) >= adv) {
            x += adv;
            track.appendChild(track.children[0]);
          }
          track.style.transform = `translate3d(${x}px,0,0)`;
          raf = requestAnimationFrame(step);
        };

        const start = () => { if (!prefersReduced) { cancelAnimationFrame(raf); raf = requestAnimationFrame(step); } };
        const stop  = () => { cancelAnimationFrame(raf); };

        start();
        wrap.addEventListener('mouseenter', stop);
        wrap.addEventListener('mouseleave', start);
        wrap.addEventListener('focusin', stop);
        wrap.addEventListener('focusout', start);
        document.addEventListener('visibilitychange', () => { document.hidden ? stop() : start(); });

        document.getElementById('ts-prev')?.addEventListener('click', () => { x += cardAdvanceWidth(); });
        document.getElementById('ts-next')?.addEventListener('click', () => { x -= cardAdvanceWidth(); });
      })();
    </script>
  </section>

  <!-- Lead Magnet: single, responsive -->
  <section class="py-16 max-w-3xl mx-auto">
    <div class="card p-6">
      <h3 class="font-semibold mb-3">Get first access to new listings</h3>
      <form action="/api/subscribe" method="POST" class="grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-3" aria-label="Email signup">
        <input type="email" name="email" required placeholder="you@email.com" class="input" />
        <button class="btn-cta rounded-md whitespace-nowrap">Get Alerts</button>
      </form>
      <p class="text-xs text-neutral-500 mt-2">No spam. Unsubscribe anytime.</p>
    </div>
  </section>
</MainLayout>
