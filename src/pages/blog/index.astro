---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

/** --------- DATA --------- */
const postsAll = (await getCollection('blog'))
  .filter((p) => !p.data.draft)
  .sort(
    (a, b) =>
      new Date(b.data.date ?? b.data.pubDate ?? 0) -
      new Date(a.data.date ?? a.data.pubDate ?? 0),
  );

/** Clean category paths (match folder names) */
const CAT_PATHS: Record<string, string> = {
  'Buyer & Renter Tips': 'buying-renting-tips',
  'Seller & Marketing Tips': 'seller-marketing-tips',
  'Short-Stay & Lifestyle': 'short-stay-lifestyle',
  'Local Living Features': 'local-living-features',
};
const CATEGORY_ORDER = [
  'Buyer & Renter Tips',
  'Seller & Marketing Tips',
  'Short-Stay & Lifestyle',
  'Local Living Features',
];

/** Pill variants for filters */
const PILL: Record<string, string> = {
  'Buyer & Renter Tips': 'pill pill-blue',
  'Seller & Marketing Tips': 'pill pill-amber',
  'Short-Stay & Lifestyle': 'pill pill-emerald',
  'Local Living Features': 'pill pill-purple',
};

const postHref = (p: any) => `/blog/${p.slug}`;
const imgOf = (p: any) => p?.data?.heroImage ?? '/images/placeholders/hero-house-1.webp';
const when = (p: any) =>
  new Date(p.data.date ?? p.data.pubDate ?? Date.now()).toLocaleDateString(undefined, {
    month: 'short', day: '2-digit', year: 'numeric'
  });

/** Featured (exactly 2) */
const featured = postsAll.slice(0, 2);

/** Grid pagination (9 per page) — exclude featured only when we still have ≥ 9 */
const url = new URL(Astro.url);
const pageSize = 9;
const page = Math.max(1, Number(url.searchParams.get('page') ?? '1'));

/* If we have enough posts, avoid duplicating featured; else include all to fill the grid */
const basePool =
  postsAll.length >= pageSize + featured.length ? postsAll.slice(2) : postsAll;

const totalPages = Math.max(1, Math.ceil(basePool.length / pageSize));
const currentPage = Math.min(page, totalPages);
const start = (currentPage - 1) * pageSize;
const pagePosts = basePool.slice(start, start + pageSize);

/** Popular (sidebar) – up to 9 compact items */
const popular = postsAll.slice(0, 9);

const title = 'Blog – Severino Realty';
const description = 'Insights, tips, and local living features.';
---

<MainLayout title={title} description={description}>
  <!-- Featured (2-up) -->
  <section class="relative mt-8">
    <h1 class="mb-4 text-2xl sm:text-3xl font-semibold">Latest highlights</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {featured.map((p) => (
        <a href={postHref(p)} class="relative block rounded-2xl overflow-hidden ring-1 ring-slate-200 group">
          <img
            src={imgOf(p)}
            alt={p.data.title}
            class="absolute inset-0 w-full h-full object-cover"
            width="1200" height="675" loading="lazy" decoding="async"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/35 to-transparent"></div>
          <div class="relative z-10 p-5 sm:p-6 lg:p-8 flex flex-col justify-end min-h-[260px] md:min-h-[320px]">
            <span class="pill--light">{p.data.category || 'Blog'}</span>
            <h2 class="mt-3 text-white text-xl sm:text-2xl font-semibold line-clamp-2">{p.data.title}</h2>
            {p.data.description && <p class="mt-2 text-white/90 text-sm line-clamp-2">{p.data.description}</p>}
          </div>
          <div class="absolute inset-0 ring-0 group-hover:ring-2 group-hover:ring-white/80 transition" />
        </a>
      ))}
    </div>
  </section>

  <!-- Category filters (pills only) -->
  <section class="mt-8">
    <nav class="flex flex-wrap gap-2" aria-label="Blog categories">
      <a href="/blog" class="pill pill-slate" aria-current="page">
        <span class="pill-dot bg-current/70"></span>All
      </a>
      {CATEGORY_ORDER.map((c) => (
        <a href={`/blog/${CAT_PATHS[c]}`} class={PILL[c]}>
          <span class="pill-dot bg-current/70"></span>{c}
        </a>
      ))}
    </nav>
  </section>

  <!-- Content + Sidebar -->
  <section class="mt-8 grid grid-cols-1 lg:grid-cols-[minmax(0,1fr)_320px] gap-12 items-start">
    <!-- Cards grid: 3 per row; up to 9 per page -->
    <div>
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {pagePosts.map((p) => (
          <a href={postHref(p)} class="rounded-xl overflow-hidden ring-1 ring-slate-200 bg-white hover:shadow-md transition">
            <div class="relative aspect-[3/2] bg-slate-100">
              <img
                src={imgOf(p)}
                alt={p.data.title}
                class="absolute inset-0 w-full h-full object-cover"
                width="900" height="600" loading="lazy" decoding="async"
              />
            </div>
            <div class="p-4">
              <div class="flex items-center gap-2 text-xs text-slate-600">
                <span class="pill pill-slate">
                  <span class="pill-dot bg-current/70"></span>{p.data.category || 'Blog'}
                </span>
                <span aria-hidden="true">·</span>
                <time datetime={new Date(p.data.date ?? p.data.pubDate ?? Date.now()).toISOString()}>{when(p)}</time>
              </div>
              <h3 class="mt-2 text-slate-900 font-semibold line-clamp-2">{p.data.title}</h3>
              {p.data.description && <p class="mt-1 text-sm text-slate-600 line-clamp-2">{p.data.description}</p>}
              <span class="mt-3 inline-block text-sm font-medium text-[color:var(--color-cta,#2563eb)]">Read more →</span>
            </div>
          </a>
        ))}
      </div>

      <!-- Pagination: always shown -->
      <nav class="mt-8 flex items-center justify-center gap-2" aria-label="Pagination">
        <a
          rel="prev"
          href={`?page=${Math.max(1, currentPage - 1)}`}
          class={`pg-btn ${currentPage === 1 ? 'pg-disabled' : ''}`}
          aria-disabled={currentPage === 1}
        >Prev</a>

        {Array.from({ length: totalPages || 1 }).map((_, i) => {
          const num = i + 1;
          return (
            <a
              href={`?page=${num}`}
              class={`pg-num ${num === currentPage ? 'pg-active' : ''}`}
              aria-current={num === currentPage ? 'page' : undefined}
            >{num}</a>
          );
        })}

        <a
          rel="next"
          href={`?page=${Math.min(totalPages, currentPage + 1)}`}
          class={`pg-btn ${currentPage === totalPages ? 'pg-disabled' : ''}`}
          aria-disabled={currentPage === totalPages}
        >Next</a>
      </nav>
    </div>

    <!-- Sidebar -->
    <aside class="space-y-6">
      <!-- Popular: up to 9 items -->
      <section class="rounded-lg border border-slate-200 p-5 bg-white">
        <h2 class="text-sm font-semibold text-slate-900">Popular</h2>
        <ul class="mt-3 space-y-3">
          {popular.map((p) => (
            <li class="flex items-center gap-3">
              <a href={postHref(p)} class="flex items-center gap-3 group">
                <div class="relative w-16 h-12 rounded-md overflow-hidden ring-1 ring-slate-200 bg-slate-100 shrink-0">
                  <img src={imgOf(p)} alt={p.data.title} class="absolute inset-0 w-full h-full object-cover" loading="lazy" width="160" height="120" />
                </div>
                <div class="min-w-0">
                  <p class="text-sm font-medium text-slate-900 line-clamp-2 group-hover:underline">{p.data.title}</p>
                  <p class="text-xs text-slate-600">{when(p)}</p>
                </div>
              </a>
            </li>
          ))}
        </ul>
      </section>

      <!-- Newsletter -->
      <section class="rounded-lg border border-slate-200 p-5 bg-white">
        <h2 class="text-sm font-semibold text-slate-900">Newsletter</h2>
        <p class="mt-1 text-sm text-slate-600">Get market intel and new posts.</p>
        <form class="mt-3 grid gap-2" onsubmit="event.preventDefault()">
          <input type="email" required placeholder="you@example.com" class="input" />
          <button class="btn-cta">Subscribe</button>
          <p class="text-xs text-slate-500">We respect privacy. Unsubscribe anytime.</p>
        </form>
      </section>
    </aside>
  </section>
</MainLayout>

<style is:inline>
  /* Local helper for featured overlay */
  .pill--light{ @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-white/90 text-slate-800; }

  /* Pagination */
  .pg-btn{ @apply inline-flex items-center px-3 py-1.5 rounded-md border border-slate-200 bg-white text-sm text-slate-700 hover:border-slate-300; }
  .pg-num{ @apply inline-flex items-center justify-center w-9 h-9 rounded-md border border-slate-200 bg-white text-sm text-slate-700 hover:border-slate-300; }
  .pg-active{ @apply bg-slate-900 text-white border-slate-900; }
  .pg-disabled{ @apply opacity-50 pointer-events-none; }

  .input{ @apply w-full rounded-md border border-slate-300 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-[color:var(--color-cta,#2563eb)]; }
  .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
</style>
